// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Company {
  id               String       @id @default(cuid())
  slug             String       @unique
  displayName      String
  shortDescription String
  websiteUrl       String?
  config           Json
  ownerEmail       String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  demoClips        DemoClip[]
  documents        Document[]
  chunks           Chunk[]
  mediaAssets      MediaAsset[]
  
  // Tavus integration fields
  tavusReplicaId   String?      // Tavus replica ID for video avatar
  tavusPersonaId    String?      // Tavus persona ID
  useTavusKB        Boolean      @default(false) // Enable Tavus Knowledge Base
  useTavusVideo     Boolean      @default(false) // Enable Tavus video avatar
  searchStrategy    String       @default("parallel") // "parallel" | "smart" | "fallback" | "your-rag-only"
  tavusKBWeight     Float        @default(0.5) // Weight for Tavus results in merge (0-1)
}

model DemoClip {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  url        String
  title      String
  persona    String?
  intentTags String?
  createdAt  DateTime @default(now())

  @@index([companyId])
}

model Document {
  id           String      @id @default(cuid())
  companyId    String
  company      Company     @relation(fields: [companyId], references: [id])
  title        String
  source       String?     // "manual", "ocr", "whisper", "pdf_extract", "pdf_page_extract", "website_page", etc.
  content      String      // Full extracted text
  createdAt    DateTime    @default(now())
  chunks       Chunk[]
  
  // Link to source media asset (if this doc came from image/video OCR)
  mediaAssetId String?
  mediaAsset   MediaAsset? @relation(fields: [mediaAssetId], references: [id])
  
  // Website-specific fields (nullable for backwards compatibility)
  url          String?     // URL of the webpage (for website pages)
  headingsPath String?     // JSON array: ["Home", "Products", "Pricing"] - breadcrumb path

  @@index([companyId])
  @@index([mediaAssetId])
  @@index([url])
}

model Chunk {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  index      Int
  content    String
  embedding  String
  
  // Rich metadata for multimodal content
  metadata   String?  // JSON: {
                      //   sourceType: "image|video|text",
                      //   mediaAssetId: "...",
                      //   timestamp: "1:45",
                      //   frameUrl: "..."
                      // }
  
  createdAt  DateTime @default(now())

  @@index([companyId])
  @@index([documentId])
}

model MediaAsset {
  id              String     @id @default(cuid())
  companyId       String
  company         Company    @relation(fields: [companyId], references: [id])
  type            String     // "image", "video", "pdf", "slide", "chart", "gif", "website"
  url             String
  title           String
  description     String?
  category        String?    // "product", "pricing", "comparison", "demo", "case-study"
  tags            String?    // JSON array of keywords
  thumbnail       String?    // For videos/PDFs
  metadata        String?    // JSON: {width, height, duration, pages, crawlConfig, etc}
  
  // Processing fields
  extractedText   String?    // OCR text from image or combined video transcript
  transcript      String?    // Full video transcript (Whisper output)
  frameAnalysis   String?    // JSON: [{timestamp, description}] from GPT-4 Vision
  processingStatus String?   // "pending", "processing", "completed", "failed"
  processedAt     DateTime?
  
  // Link to RAG documents created from this asset
  documents       Document[]
  
  createdAt       DateTime   @default(now())

  @@index([companyId])
  @@index([type])
  @@index([category])
  @@index([processingStatus])
}

